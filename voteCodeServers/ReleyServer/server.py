import sys
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import uvicorn
from typing import Optional, List
import threading
from pymongo import MongoClient
from pymongo.errors import ConnectionFailure


class DataProvider:
    TEST_DATA_STRUCTURE = [
        [304858297181034217761486010391045667147044268541545179333912415999326816116164253535103179108258809139693715056715976188021086527631761173238688760840260623337044310057293266233811188837278770149796122597082992284185971675660212140560697432435502508376558235922590635210155373231632353846731197858577439205251381,
         50466345355484651911647475553357312922099417991644905624634853689780603913798787544512538570463435515538244085021499371536533905123491101243636449411114335427121870030578925085538184531375771466079735726085967438922103438558250648106254513663654700688776772469783052113346499774072359297412415933007192194133136,
         77029886366429470370274023637519126177986300958330259456834241907619765943830648563293121380218411234764686657833652357493009316176085526358139086335950367140072318566329301691373119562001899780836426368856777954173704148247373904870724002229086694426347353942774127629953307529872539161414508788793275441162539
            ], # Serwer ID 1
        [372890925166487389347160638116362906405370642086750573115053327926328910126048180445536812412034078401041411730092834164122755328231177283729549993863271152606139543519476672720129358714115522960898892196232638479211474465969542133844042175872462060397538682635615915559777752475901799021907003037441251856175080, 
         18134265497446153554572806619811690556212889919810393397973307472767218013216953183899746038380457329461805972220370094390838621539071792963313723925177350567622245388927506406668692344521697670201066493697012984186656547082842378849987118321145434786647852803588381748025125608481281514429661629103134697242628, 
         388653975405493030691775569026645933282519359584516270169239985018778592144313950906072092039927913962128052832878827874353778821118767483808639229714830950588476848667695421987379556521283746051481621326098801944238166628041109878619579897532388841287040170454272705260164468507651465044003203890047862179098799
         ], # Serwer ID 2
        [131744714596378644775564928368581728459431907908423135809374718470994533157536167982517577894425547899636005812661163200926573056629915756231887875298540948302586692736792018265684585090577083493971179132629778218475554742045481153005122996559496375437676267841265209763013994282630566667330942556839043086229308, 
         266432086031752005545596523631237160400525979440189415440604444561848953012384840147167174256019899369479714541141742804760181045399973206093870634492348994365426365690139863162448287036270120375747756026796092668774063135480647598504449356675747682493598964012856864568324557722264130687148684622624304205530144, 
         302623823374547171973199564895852828802645341153149925898654334307791723642901505258131297557385211611193151883412054127301133118742227000664194745616879643163230563880501893116277937407070564182231691774999028394859164755423345137669486010761435314558789345912477618108686113067072601802819502384618720918422306
         ], # Serwer ID 3
        [231414877489957875527458491573931249311524142602412307915700218723709491727121485252318544369489605615275768152530308538917143149334728521311556605849442042609505150467519676701870268089757844162367671147455501100628650798408329957273817962560133967825850183752059365199317181203981376884241509661675401069980666, 
         362320168133698190145357577833811665139415032042318292062352065022225182920768008588394654025897519608500640049590696818363144611674714065400719967837814561792747949851606983787300883828222022211821763127888738316608275248085346867463268875798323730871197360611940679218507927570246778663970285340520381153769479, 
         26675328984103522468975776933496805722833721279342670412341086726721229774284959677242059857258184593373279776230657413439093967305733762416550916769911897634103718691552551490720785033103670570822858224773105146176108984252273567375413085332190619435438579441364674589025633604500598449438288521042475462241900
         ], # Serwer ID 4
        [180711661374493869714704807847138850582250234869277269367215618530022576340680891301726966290396600280619828462527735409782142050354774676537907037862836039301949533684930521161714629373463557522739535370597154529709317244898690942603311647196818069877419588979525716941058703942016098337127939509241386360668147, 
         379478610775366789572103829017060818870341849557941032816147153838500107440357146420245530850261986070285559787716518450175794047460854437577770315957242126214191433683121806066184903498206335323552072670804037322605640260781776049050355333137238360539335792964199068108797723392340097776184451014715318280712078, 
         86719811492468068888641077839836315018225967590803940523222863445914711174638810252575416900317960580819350528667513935538443064837321739249590562507619206450139326814936401619484365562967193423275387420119497680149547236682560210743515229731576192905008956455336444933034792161213035970510247005988300432759254
         ], # Serwer ID 5
        [131873186339317937700698883499685200517542052141063327522313425550529003417124123263656746289924334321704088077590229594206916755331920743020297034249508363907740262915874545587065151120241610107266564363092218404481709142922974869120792399000831327820664334249586063384716861490323414413988919494837753725495986, 
         452483686369944271711590477508924053691481852557369032911478273119105072882826231973570260111901351622463731662800199124398113056206648015895365693602093174423457433314389391469216907176085251384223319527337333945713713789450113340046976874026424227065542353837560815700062678524804809283917513220613470958109983, 
         200253562249782503274138039777476618772182721369358422213116889107553781728998946372797469934788193462970706611344554125850292416405857070117765351838039277470808533530805747952415059022831149400660790977857774368141835094819335307920883528800443889244547796543153113998129520195837148330117264518345733192712122
         ], # Serwer ID 6
        [260687742235794464868287249878198254558707156543133528885714997123131864426176800244911191593981466963959752876387022145483751861508051798615638108392172200252185887248495644693132888216037961249694620592430660143131239594561177995647651157984503645760130449113529506018653226665694658325895032869986048358703719, 
         43805069572113910370477239774316126619716572428398892896393856164715905008888488247379104473969051074653277371834609540283572906565006107777344928037083444065257443230073338824941841155653695451622709482437530471308482312534996267488873926828664874884367981521758497665256524211330674685461187355730086085733387, 
         262331572369159676907236904881637506382243126678866769321043497606232523123938910453979558609578576810718808003558616093284593159984905272944515952016845316374641985735062167769996642390189082436260265928674379157137494209870859271804120747015627797236948382288790232666219641075822527231639984294128038521778958
         ], # Serwer ID 7
        [460379807289947835020310476470064614962486317062514398465352177442992325455541065473875023508664730882345011840860569770663110803980892451887915024180003039011110301994248128431498016578591771834393539387039521575531807298338226316909990269078949677715448532010768305823005575866885356555393737397001971925274296, 
         462229062329603301311581897008483368180334560116060047241941420927878715424384377534852166931043739840684002303641693405799830475946212234408644862373707447401186550169620542499816766145760208961957674845977000820528714406480781990942460093955733068980532112438639565355899162468161793304685932530897818607568115, 
         99502114504635617726826451016418444317540591387339624688296996542938903195179346380026620897272116673969994360874288013297059594110992418789610647205637100752949130390639556875156990335533320390887319299096478038932744509253800363813457345775049637414368232350573334867119597715403976771610711304799638508808005
         ], # Serwer ID 8
        [306597114889731876393719256055254870083758933742728341848103408230841603167919379156562067432367360092602086705633325463561612322487408019716932974070212325119600277190570892790653168466945268906796363909366029120065382662357397293865947033112959441276719467062840337342122792475967733297992145575508843393857977, 
         271649758264643458763983203661510107132417721950164916802164977096599840208521327843591014458098183678594605695702357355834981059702009361029710694673630937526119139943772076999640141788359091706039710659984896408414305617964427239978963742266894267284167104884028907312547749571292035025361296104903432155216742, 
         260197370267808205743498909887015085304626954507031224914603475757491799212356600183147875151895719800578548659542923977035027156367185969764779963386115367000550230201585267156017955305228511472601855689477232020612272410059077771520183925556622694855827996644858572420792117362268804743230574473068762101065865
         ], # Serwer ID 9
        [88759576072099537359913504844254305591051367491259168208108937628237941097085218359211147495336021556909008310475463706242045789540241792537854000467947782295765377723796018947722720329420616379333046875211656054600072586632593284394516307086934399242534174305771869954146978404700258658346870772571954552448514, 
         312614662936241656486525108784538273169426315219265397752198908881442395609568021144011679090871268163743414162300128314991141363711130397263047146031566313864682071608558481329989969500648591489648546326663670380833451960291624487022748486448812197236591322152147887528414515795192125091812319297401623142835821, 
         278334677122072821127933309106554725783694051679710155973141053883367708205462537810075424440238383797232928948718742089151800040724875450730377039496640963340821306066509190653491162132304502852840781686193512314993757108786985917110761852442623867501124029959614466993960105115585697982796173845316571138151683
         ]  # Serwer ID 10
    ]
    
    BATCH_SIZE = 1000
    
    def __init__(self, server_id: int, test_mode: bool = False):
        self._lock = threading.Lock()
        self._test_mode = test_mode
        self._server_id = server_id
        
        self._data_buffer = []
        self._buffer_index = 0
        
        self._db_client = None
        self._db_collection = None
        self._db_skip = 0
        
        if test_mode:
            # testing mode with hardcoded data
            if 1 <= server_id <= len(self.TEST_DATA_STRUCTURE):
                self._data_buffer = self.TEST_DATA_STRUCTURE[server_id - 1] 
                print(f"[TEST MODE] Server {server_id} initialized with {len(self._data_buffer)} items")
            else:
                print(f"[TEST MODE] Server {server_id} has no test data (only servers 1-{len(self.TEST_DATA_STRUCTURE)} supported)")
        else:
            # production mode - initialize MongoDB connection
            self._init_mongodb()
            # load first batch
            self._load_next_batch()
    
    def _init_mongodb(self):
        try:
            self._db_client = MongoClient("mongodb://localhost:27017", serverSelectionTimeoutMS=5000)
            self._db_client.admin.command('ping')
            
            database = self._db_client[f"server_{self._server_id}"]
            self._db_collection = database["PartialDecryptions"]
            
            print(f"[PRODUCTION MODE] Server {self._server_id} connected to MongoDB")
            
        except Exception as e:
            print(f"[ERROR] Failed to connect to MongoDB: {e}")
            self._db_collection = None
    
    def _load_next_batch(self):
        if self._db_collection is None:
            return
        
        try:
            with self._lock:
                # fetch batch from database
                documents = list(self._db_collection.find({}).skip(self._db_skip).limit(self.BATCH_SIZE))
                
                self._data_buffer.clear()
                self._buffer_index = 0
                
                for doc in documents:
                    if "PartialDecryption" in doc:
                        self._data_buffer.append(doc["PartialDecryption"])
                
                self._db_skip += self.BATCH_SIZE
                
                if self._data_buffer:
                    print(f"[DB LOAD] Server {self._server_id} loaded batch of {len(self._data_buffer)} items (skip={self._db_skip - self.BATCH_SIZE})")
                else:
                    print(f"[DB LOAD] Server {self._server_id} reached end of data")
                    
        except Exception as e:
            print(f"[ERROR] Failed to load batch from database: {e}")
    
    @property
    def current_index(self) -> int:
        with self._lock:
            total_served = (self._db_skip - self.BATCH_SIZE) + self._buffer_index
        return total_served
    
    @property
    def total_data_count(self) -> int:
        if self._db_collection is None:
            return len(self._data_buffer)
        try:
            return self._db_collection.count_documents({})
        except:
            return -1
    
    # get the next batch of data
    def get_next_data(self) -> Optional[str]:
        with self._lock:
            if self._buffer_index >= len(self._data_buffer):
                if not self._test_mode and self._db_collection is not None:
                    pass
        
        if self._buffer_index >= len(self._data_buffer) and not self._test_mode and self._db_collection is not None:
            self._load_next_batch()
        
        with self._lock:
            if self._buffer_index < len(self._data_buffer):
                data = self._data_buffer[self._buffer_index]
                self._buffer_index += 1
                return data
            else:
                # no more data
                return None
    
    def reset_index(self):
        with self._lock:
            self._buffer_index = 0
            if not self._test_mode:
                self._db_skip = 0
    
    def reload_data_from_database(self):
        if not self._test_mode:
            self._init_mongodb()
            self._load_next_batch()
            self.reset_index()


if len(sys.argv) < 2:
    print("Usage: python server.py <serverId> [test]")
    print("Examples:")
    print("  python server.py 1 test    # Run in test mode with hardcoded data")
    print("  python server.py 1         # Run in production mode (database)")
    sys.exit(1)

server_id = int(sys.argv[1])
test_mode = len(sys.argv) > 2 and sys.argv[2].lower() == "test"
my_port = 5000 + server_id

app = FastAPI(title=f"ReleyServer {server_id}", version="1.0")
data_provider = DataProvider(server_id, test_mode)


@app.get("/api/data/next")
async def get_next_data_endpoint():
    data = data_provider.get_next_data()
    
    if data is not None:
        return {
            "success": True,
            "serverId": server_id,
            "data": data,
            "index": data_provider.current_index - 1
        }
    else:
        raise HTTPException(
            status_code=404,
            detail={
                "success": False,
                "serverId": server_id,
                "message": "No more data available"
            }
        )


@app.get("/api/data/status")
async def get_status():
    return {
        "serverId": server_id,
        "currentIndex": data_provider.current_index,
        "totalDataCount": data_provider.total_data_count,
        "remainingItems": max(0, data_provider.total_data_count - data_provider.current_index) if data_provider.total_data_count > 0 else 0
    }


if __name__ == "__main__":
    mode_str = "TEST MODE" if test_mode else "PRODUCTION MODE"
    print(f"ReleyServer {server_id} starting on port {my_port} [{mode_str}]")
    uvicorn.run(app, host="127.0.0.1", port=my_port)
